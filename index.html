<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프리패스 모빌리티 ERP</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        body { font-family: 'Pretendard', sans-serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .animate-drawer { animation: slideIn 0.3s cubic-bezier(0, 0, 0.2, 1) forwards; }
    </style>
</head>
<body class="bg-[#f1f3f6]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // Lucide 아이콘 컴포넌트 래퍼
        const Icon = ({ name, size = 16, className = "" }) => {
            const IconComponent = lucide[name];
            return IconComponent ? <i data-lucide={name} className={className} style={{width: size, height: size}}></i> : null;
        };

        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vREzDg6YIAoZBiSeT58g6sksXFZkILyX0hKJeuQIdfKxWDRgu7SX7epVkuKMjXvp8n10-sNCoWRyJdJ/pub?gid=1259006970&single=true&output=csv";

        // --- 컴포넌트 ---
        const StatusBadge = ({ text, type }) => {
            if (!text) return null;
            let colorClass = "bg-slate-100 text-slate-600 border-slate-200";
            if (type === '구분') {
                if (text === '신차') colorClass = "bg-blue-50 text-blue-700 border-blue-100";
                else if (text === '중고') colorClass = "bg-slate-100 text-slate-700 border-slate-200";
            } else if (type === '상태' || type === '세부상태') {
                const t = String(text);
                if (t.includes('가능') || t === '출고가능' || t === '정상') colorClass = "bg-emerald-50 text-emerald-700 border-emerald-100";
                else if (t.includes('완료') || t.includes('불가')) colorClass = "bg-rose-50 text-rose-700 border-rose-100";
                else colorClass = "bg-amber-50 text-amber-700 border-amber-100";
            }
            return (
                <span className={`inline-flex items-center justify-center px-1.5 py-0.5 border text-[10px] font-black leading-none whitespace-nowrap rounded-none ${colorClass}`}>
                    {text}
                </span>
            );
        };

        const SafeHtml = ({ html }) => {
            if (!html || html === '-') return <span className="text-slate-400">내용 없음</span>;
            return <div dangerouslySetInnerHTML={{ __html: String(html).replace(/\n/g, '<br/>') }} />;
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedCar, setSelectedCar] = useState(null);
            const [isRefreshing, setIsRefreshing] = useState(false);
            const [selectedPeriods, setSelectedPeriods] = useState(['36M', '48M', '60M']);
            const [managerInfo, setManagerInfo] = useState({
                company: localStorage.getItem('erp_manager_company') || '',
                nameTitle: localStorage.getItem('erp_manager_nameTitle') || '',
                phone: localStorage.getItem('erp_manager_phone') || '',
                includeAccount: localStorage.getItem('erp_manager_includeAcc') === 'true'
            });

            const parseNum = (str) => parseInt(String(str).replace(/[^0-9]/g, '')) || 0;
            const formatPrice = (val) => parseNum(val).toLocaleString();

            const fetchData = async () => {
                setIsRefreshing(true);
                try {
                    const response = await fetch(`${CSV_URL}&cachebust=${Date.now()}`);
                    const text = await response.text();
                    const rows = text.split(/\r?\n/).filter(r => r.trim());
                    const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    const jsonData = rows.slice(1).map(row => {
                        const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v ? v.trim().replace(/^"|"$/g, '').replace(/""/g, '"') : "");
                        return headers.reduce((obj, header, i) => { obj[header] = values[i] || ""; return obj; }, {});
                    });
                    setData(jsonData);
                } catch (e) { console.error(e); }
                setIsRefreshing(false);
                setTimeout(() => lucide.createIcons(), 100);
            };

            useEffect(() => { 
                fetchData();
                localStorage.setItem('erp_manager_company', managerInfo.company);
                localStorage.setItem('erp_manager_nameTitle', managerInfo.nameTitle);
                localStorage.setItem('erp_manager_phone', managerInfo.phone);
                localStorage.setItem('erp_manager_includeAcc', String(managerInfo.includeAccount));
            }, [managerInfo]);

            const filteredData = useMemo(() => {
                return data.filter(item => Object.values(item).some(v => String(v).toLowerCase().includes(searchTerm.toLowerCase())));
            }, [data, searchTerm]);

            const baseColumns = { "상태": "차량_상태", "구분": "차량_구분", "차량번호": "차량_번호", "제조사": "차량_제조사", "모델": "차량_모델명", "세부모델": "차량_세부모델", "주행거리": "차량_현재주행거리" };

            return (
                <div className="flex h-screen bg-[#f1f3f6] text-slate-900 overflow-hidden text-[11px] select-none">
                    {/* 좌측 바 */}
                    <div className="w-[72px] bg-white border-r border-slate-200 flex flex-col items-center pt-20 gap-2 z-50">
                        <div className="p-2 bg-blue-50 text-blue-700 font-black rounded text-[10px]">ERP</div>
                    </div>

                    <div className="flex-1 flex flex-col min-w-0">
                        <header className="h-[50px] bg-white border-b border-slate-200 flex items-center px-4 gap-4 shadow-sm z-20">
                            <input type="text" placeholder="매물 검색..." className="w-64 p-2 border border-slate-200 outline-none focus:border-blue-400" onChange={e => setSearchTerm(e.target.value)} />
                            <div className="ml-auto flex items-center gap-4 font-black">
                                <span>재고: {filteredData.length}건</span>
                                <button onClick={fetchData} className="px-3 py-1.5 border border-slate-300 hover:bg-slate-50">최신화</button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-auto bg-white">
                            <table className="w-full border-collapse text-center">
                                <thead className="sticky top-0 bg-slate-50 font-bold text-slate-500 border-b">
                                    <tr className="divide-x">
                                        {Object.keys(baseColumns).map(label => <th key={label} className="py-2">{label}</th>)}
                                        {selectedPeriods.map(p => <th key={p} className="bg-blue-50 text-blue-800">{p.replace('M','개월')}</th>)}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filteredData.map((item, idx) => (
                                        <tr key={idx} onClick={() => setSelectedCar(item)} className={`hover:bg-slate-50 cursor-pointer h-[48px] ${selectedCar?.차량_번호 === item.차량_번호 ? 'bg-blue-50 font-bold' : ''}`}>
                                            <td className="p-1"><StatusBadge text={item.차량_상태} type="상태"/></td>
                                            <td className="p-1"><StatusBadge text={item.차량_구분} type="구분"/></td>
                                            <td className="p-1 font-bold">{item.차량_번호}</td>
                                            <td className="p-1">{item.차량_제조사}</td>
                                            <td className="p-1 font-black">{item.차량_모델명}</td>
                                            <td className="p-1 text-left truncate px-4">{item.차량_세부모델}</td>
                                            <td className="p-1 text-right pr-4">{item.차량_현재주행거리}km</td>
                                            {selectedPeriods.map(p => <td key={p} className="bg-blue-50/20 text-blue-800 font-black">{item[`금액_대여료_${p}`]}</td>)}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* 상세 페이지 (5단계 섹션) */}
                        <div className={`fixed right-0 top-0 h-full w-[440px] bg-white shadow-2xl z-[100] border-l flex flex-col transition-transform duration-300 ${selectedCar ? 'translate-x-0 animate-drawer' : 'translate-x-full'}`}>
                            {selectedCar && (
                                <>
                                    <div className="h-[50px] flex justify-between items-center px-4 border-b bg-white">
                                        <span className="font-black text-[12px]">상세 정보</span>
                                        <button onClick={() => setSelectedCar(null)} className="text-slate-400 text-xl">×</button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-4 space-y-4 hide-scrollbar">
                                        {/* 1. 차량 */}
                                        <section className="border border-slate-200 p-3">
                                            <div className="text-blue-700 font-black mb-2">1. 차량 제원</div>
                                            <div className="space-y-1 font-bold">
                                                <p>번호: {selectedCar.차량_번호}</p>
                                                <p>모델: {selectedCar.차량_제조사} {selectedCar.차량_모델명}</p>
                                                <div className="mt-2 p-2 bg-slate-50 border text-[10px]">
                                                    <SafeHtml html={selectedCar.차량_비고} />
                                                </div>
                                            </div>
                                        </section>
                                        {/* 2. 대여료 */}
                                        <section className="border border-slate-200 p-3">
                                            <div className="text-slate-600 font-black mb-2">2. 대여료 안내</div>
                                            <div className="divide-y text-[10px]">
                                                {['36M', '48M', '60M'].map(m => (
                                                    <div key={m} className="flex justify-between py-1">
                                                        <span>{m.replace('M','개월')}</span>
                                                        <b className="text-blue-800">월 {selectedCar[`금액_대여료_${m}`]} / 보 {selectedCar[`금액_보증금_${m}`]}</b>
                                                    </div>
                                                ))}
                                            </div>
                                        </section>
                                        {/* 3. 보험 */}
                                        <section className="border border-slate-200 p-3">
                                            <div className="text-slate-600 font-black mb-2">3. 보험 조건</div>
                                            <div className="text-[10px] space-y-1">
                                                <p>대인/대물: {selectedCar.보험_대인 || '무한'} / {selectedCar.보험_대물 || '1억'}</p>
                                                <p class="text-rose-600 font-bold">자차 면책금: {selectedCar.보험_최소면책금}~{selectedCar.보험_최대면책금}</p>
                                            </div>
                                        </section>
                                        {/* 4. 계약 */}
                                        <section className="border border-slate-200 p-3">
                                            <div className="text-slate-600 font-black mb-2">4. 계약 특이사항</div>
                                            <div className="p-2 bg-amber-50 text-[10px]">
                                                <SafeHtml html={selectedCar.계약_비고} />
                                            </div>
                                        </section>
                                        {/* 5. 담당자 */}
                                        <section className="border border-slate-200 p-3">
                                            <div className="text-slate-600 font-black mb-2">5. 담당자 정보</div>
                                            <div className="space-y-2">
                                                <input className="w-full p-2 border" placeholder="소속" value={managerInfo.company} onChange={e => setManagerInfo({...managerInfo, company: e.target.value})} />
                                                <input className="w-full p-2 border" placeholder="연락처" value={managerInfo.phone} onChange={e => setManagerInfo({...managerInfo, phone: e.target.value})} />
                                            </div>
                                        </section>
                                    </div>
                                    <div className="p-3 border-t bg-white grid grid-cols-2 gap-2">
                                        <button className="py-3 border font-black hover:bg-slate-50">링크 복사</button>
                                        <button className="py-3 bg-slate-800 text-white font-black">텍스트 복사</button>
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
