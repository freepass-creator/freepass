import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Search, X, RefreshCw, Download, Car, Shield, 
  FileText, User, CreditCard, ExternalLink, Database,
  ChevronRight, CheckCircle2, Copy, Filter,
  ArrowUpDown, ArrowUp, ArrowDown, Calendar, 
  Banknote, Coins, Gauge, History, Lock, Clock, CalendarDays,
  Info, Sparkles, AlertCircle, Phone, Wrench, Share2
} from 'lucide-react';

// [1] 구글 시트 웹 게시 URL
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vREzDg6YIAoZBiSeT58g6sksXFZkILyX0hKJeuQIdfKxWDRgu7SX7epVkuKMjXvp8n10-sNCoWRyJdJ/pub?gid=1259006970&single=true&output=csv";

// 필터 옵션
const rentalOptions = ['50만 이하', '50~60', '60~70', '70~80', '80~90', '90~100', '100만 이상'];
const depositOptions = ['100만 이하', '100~200', '200~300', '300~400', '400~500', '500만 이상'];
const mileageOptions = ['1만km 미만', '1~3만', '3~5만', '5~10만', '10만km 이상'];
const yearOptions = ['1년 미만', '1~2년', '2~3년', '3~4년', '4~5년', '5년 이상'];

const StatusBadge = ({ text, type }) => {
  if (!text) return null;
  let colorClass = "bg-slate-100 text-slate-600 border-slate-200";
  if (type === '구분') {
    if (text === '신차') colorClass = "bg-blue-50 text-blue-700 border-blue-100";
    else if (text === '중고') colorClass = "bg-slate-100 text-slate-700 border-slate-200";
  } else if (type === '상태' || type === '세부상태') {
    const t = String(text);
    if (t.includes('가능') || t === '출고가능' || t === '정상') colorClass = "bg-emerald-50 text-emerald-700 border-emerald-100";
    else if (t.includes('완료') || t.includes('불가')) colorClass = "bg-rose-50 text-rose-700 border-rose-100";
    else colorClass = "bg-amber-50 text-amber-700 border-amber-100";
  }
  return (
    <span className={`inline-flex items-center justify-center px-1.5 py-0.5 border text-[10px] font-black leading-none whitespace-nowrap ${colorClass}`}>
      {text}
    </span>
  );
};

const WonIcon = ({ size = 20, className = "" }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <path d="M4 10h16M4 14h16M7 6l5 12 5-12" />
  </svg>
);

const App = () => {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedCar, setSelectedCar] = useState(null);
  const [copyFeedback, setCopyFeedback] = useState(false);
  const [copyLinkFeedback, setCopyLinkFeedback] = useState(false);
  
  const [managerInfo, setManagerInfo] = useState({
    company: localStorage.getItem('erp_manager_company') || '',
    nameTitle: localStorage.getItem('erp_manager_nameTitle') || '',
    phone: localStorage.getItem('erp_manager_phone') || '',
    includeAccount: localStorage.getItem('erp_manager_includeAcc') === 'true'
  });

  const [selectedPeriods, setSelectedPeriods] = useState(['24M']); 
  const [columnFilters, setColumnFilters] = useState({}); 
  const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' }); 
  const [sidebarFilters, setSidebarFilters] = useState({ rental: [], deposit: [], mileage: [], year: [] });
  const [activeFilterColumn, setActiveFilterColumn] = useState(null); 
  const [activeSidebarPopup, setActiveSidebarPopup] = useState(null); 
  const filterRef = useRef(null);
  const sidebarPopupRef = useRef(null);

  const parseNum = (str) => {
    const val = parseInt(String(str).replace(/[^0-9]/g, ''));
    return isNaN(val) ? 0 : val;
  };

  const formatPrice = (val) => {
    const num = parseNum(val);
    return num.toLocaleString();
  };

  const formatPeriod = (p) => p ? p.replace('M', '개월') : "";

  const togglePeriod = (p) => {
    setSelectedPeriods(prev => {
      const periodsOrder = ['6M', '12M', '24M', '36M', '48M', '60M'];
      const next = prev.includes(p) ? (prev.length > 1 ? prev.filter(x => x !== p) : prev) : [...prev, p];
      return next.sort((a, b) => periodsOrder.indexOf(a) - periodsOrder.indexOf(b));
    });
  };

  const toggleSidebarFilter = (key, value) => {
    setSidebarFilters(prev => {
      const current = prev[key];
      const next = current.includes(value) ? current.filter(v => v !== value) : [...current, value];
      return { ...prev, [key]: next };
    });
  };

  const handleCarClick = (car) => {
    if (selectedCar && selectedCar.차량_번호 === car.차량_번호) setSelectedCar(null);
    else { setSelectedCar(car); setCopyFeedback(false); setCopyLinkFeedback(false); }
  };

  const handleCopySummary = () => {
    if (!selectedCar) return;
    let text = `[상품 상세 정보]\n\n`;
    text += `1. 차량 상세 제원\n■ 차량번호: ${selectedCar.차량_번호} (${selectedCar.차량_구분}/${selectedCar.차량_상태})\n■ 모델명: ${selectedCar.차량_제조사} ${selectedCar.차량_모델명} ${selectedCar.차량_세부모델}\n■ 세부트림: ${selectedCar.차량_세부트림}\n■ 선택옵션: ${selectedCar.차량_선택옵션 || '기본 사양'}\n■ 주요제원: ${selectedCar.차량_연료 || '-'} / ${selectedCar.차량_배기량 ? formatPrice(selectedCar.차량_배기량) + 'cc' : '-'} / ${formatPrice(selectedCar.차량_현재주행거리)}km\n■ 색상(내/외): ${selectedCar.차량_내부색상} / ${selectedCar.차량_외부색상}\n■ 사진확인: ${selectedCar.차량_사진링크 || '링크 정보 없음'}\n\n`;
    text += `2. 대여료 및 보증금 안내 (부가세 포함)\n`;
    ['6M', '12M', '24M', '36M', '48M', '60M'].forEach(m => {
      const fee = selectedCar[`금액_대여료_${m}`];
      const dep = selectedCar[`금액_보증금_${m}`];
      if (fee && fee !== '-' && fee !== '0') text += `■ ${formatPeriod(m)}: 월 대여료 ${fee} / 보증금 ${dep}\n`;
    });
    text += `\n3. 보험 보상 상세\n■ 대인: ${selectedCar.보험_대인 || '무한'} (면책금: ${selectedCar.보험_대인면책금 || '0원'})\n■ 대물: ${selectedCar.보험_대물 || '1억원'} (면책금: ${selectedCar.보험_대물면책금 || '10만'})\n■ 자손: ${selectedCar.보험_자손 || '3천만'}\n■ 자차: 차량가액 한도 (면책금: ${selectedCar.보험_최소면책금 || '20만'}~${selectedCar.보험_최대면책금 || '50만'})\n\n`;
    text += `4. 계약 조건\n■ 연령: ${selectedCar.계약_기본운전연령 || '만 26세'}\n■ 거리: ${selectedCar.계약_약정주행거리 || '2만km'}\n\n`;
    text += `5. 담당자 정보\n■ 담당: ${managerInfo.company || '-'} ${managerInfo.nameTitle || '-'}\n■ 연락처: ${managerInfo.phone || '-'}\n`;
    if (managerInfo.includeAccount) text += `■ 입금계좌: ${selectedCar.계약_입금계좌번호 || '정보 없음'}\n`;
    
    const textArea = document.createElement("textarea");
    textArea.value = text; document.body.appendChild(textArea); textArea.select();
    document.execCommand('copy'); document.body.removeChild(textArea);
    setCopyFeedback(true); setTimeout(() => setCopyFeedback(false), 2000);
  };

  const fetchData = async () => {
    setLoading(true);
    try {
      const response = await fetch(`${CSV_URL}&cachebust=${Date.now()}`);
      const text = await response.text();
      const rows = text.split(/\r?\n/).filter(r => r.trim());
      const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
      const jsonData = rows.slice(1).map(row => {
        const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v ? v.trim().replace(/^"|"$/g, '').replace(/""/g, '"') : "");
        return headers.reduce((obj, header, i) => { obj[header] = values[i] || ""; return obj; }, {});
      });
      setData(jsonData);
    } catch (e) { console.error(e); } finally { setLoading(false); }
  };

  useEffect(() => { fetchData(); }, []);
  useEffect(() => {
    localStorage.setItem('erp_manager_company', managerInfo.company);
    localStorage.setItem('erp_manager_nameTitle', managerInfo.nameTitle);
    localStorage.setItem('erp_manager_phone', managerInfo.phone);
    localStorage.setItem('erp_manager_includeAcc', managerInfo.includeAccount);
  }, [managerInfo]);

  const filteredData = useMemo(() => {
    return data.filter(item => {
      const matchesSearch = Object.values(item).some(v => String(v).toLowerCase().includes(searchTerm.toLowerCase()));
      const matchesColumn = Object.entries(columnFilters).every(([col, sel]) => !sel?.length || sel.includes(String(item[col])));
      return matchesSearch && matchesColumn;
    });
  }, [searchTerm, data, columnFilters]);

  const baseColumns = { "상태": "차량_상태", "구분": "차량_구분", "차량번호": "차량_번호", "제조사": "차량_제조사", "모델": "차량_모델명", "세부모델": "차량_세부모델", "세부트림(선택옵션)": "차량_세부트림", "외부색상": "차량_외부색상", "내부색상": "차량_내부색상", "주행거리": "차량_현재주행거리" };

  return (
    <div className="flex h-screen bg-[#f1f3f6] text-slate-900 overflow-hidden font-sans text-[11px]">
      <style>{`@keyframes drawerAppear { 0% { transform: translateX(100%); } 100% { transform: translateX(0); } } .animate-drawer { animation: drawerAppear 0.3s ease-out; }`}</style>
      
      {/* 사이드바 */}
      <div className="w-[68px] bg-white border-r flex flex-col items-center pt-20 gap-2">
        <button onClick={() => setActiveSidebarPopup('period')} className="flex flex-col items-center gap-1 p-2 hover:bg-slate-50 w-full">
          <CalendarDays size={20} className="text-slate-400" />
          <span className="text-[9px]">기간</span>
        </button>
        <button onClick={() => setActiveSidebarPopup('rental')} className="flex flex-col items-center gap-1 p-2 hover:bg-slate-50 w-full">
          <WonIcon size={20} className="text-slate-400" />
          <span className="text-[9px]">대여료</span>
        </button>
      </div>

      <div className="flex-1 flex flex-col relative">
        <header className="h-[50px] bg-white border-b flex items-center px-4 gap-4">
          <div className="relative flex-1 max-w-sm">
            <Search className="absolute left-2.5 top-2.5 text-slate-400" size={16} />
            <input type="text" placeholder="매물 통합 검색..." className="w-full pl-9 pr-4 py-1.5 border rounded text-xs focus:outline-none focus:border-blue-600" onChange={e => setSearchTerm(e.target.value)} />
          </div>
          <div className="ml-auto flex items-center gap-3">
             <span className="text-slate-500 font-medium">매물수: <b className="text-blue-600">{filteredData.length}</b>건</span>
             <button onClick={fetchData} className="flex items-center gap-1.5 px-3 py-1.5 border font-bold text-blue-600 bg-white hover:bg-slate-50"><RefreshCw size={12}/> 최신화</button>
          </div>
        </header>

        <div className="flex-1 overflow-auto bg-white m-2 border shadow-sm">
          <table className="w-full border-collapse text-center table-fixed">
            <thead className="sticky top-0 bg-slate-50 border-b z-10 font-bold text-slate-600">
              <tr className="divide-x">
                {Object.keys(baseColumns).map(label => (
                  <th key={label} className="py-2 px-1 truncate">{label}</th>
                ))}
                {selectedPeriods.map(p => <th key={p} className="bg-blue-50 text-blue-700 w-24">{p} 대여료</th>)}
              </tr>
            </thead>
            <tbody className="divide-y">
              {filteredData.map((item, idx) => (
                <tr key={idx} onClick={() => handleCarClick(item)} className={`hover:bg-blue-50 cursor-pointer h-10 ${selectedCar?.차량_번호 === item.차량_번호 ? 'bg-blue-50' : ''}`}>
                  <td className="px-1"><StatusBadge text={item.차량_상태} type="상태" /></td>
                  <td className="px-1"><StatusBadge text={item.차량_구분} type="구분" /></td>
                  <td className="font-bold">{item.차량_번호}</td>
                  <td>{item.차량_제조사}</td>
                  <td className="font-bold">{item.차량_모델명}</td>
                  <td className="truncate text-left">{item.차량_세부모델}</td>
                  <td className="truncate text-left text-slate-500">{item.차량_세부트림}</td>
                  <td>{item.차량_외부색상}</td>
                  <td>{item.차량_내부색상}</td>
                  <td className="text-right pr-2">{formatPrice(item.차량_현재주행거리)}km</td>
                  {selectedPeriods.map(p => <td key={p} className="text-blue-700 font-bold">{item[`금액_대여료_${p}`]}</td>)}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* 우측 상세 정보 Drawer */}
        {selectedCar && (
          <div className="absolute right-0 top-0 h-full w-[400px] bg-white shadow-2xl border-l z-50 flex flex-col animate-drawer">
            <div className="h-11 border-b flex justify-between items-center px-4">
              <h2 className="font-bold flex items-center gap-2"><Car size={16} className="text-blue-600"/> 상품 상세 정보</h2>
              <button onClick={() => setSelectedCar(null)}><X size={18}/></button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-4">
              {/* 1. 차량 상세 제원 */}
              <section className="border rounded overflow-hidden">
                <div className="bg-slate-50 px-2 py-1 border-b font-bold text-slate-600">1. 차량 상세 제원</div>
                <div className="p-2 space-y-1">
                  <div className="flex justify-between"><span>차량번호</span><span className="font-bold text-blue-700">{selectedCar.차량_번호}</span></div>
                  <div className="flex justify-between"><span>모델명</span><span className="font-bold">{selectedCar.차량_모델명}</span></div>
                  <div className="flex justify-between"><span>주행거리</span><span className="font-bold">{formatPrice(selectedCar.차량_현재주행거리)}km</span></div>
                </div>
              </section>

              {/* 2. 대여료 안내 */}
              <section className="border rounded overflow-hidden">
                <div className="bg-slate-50 px-2 py-1 border-b font-bold text-slate-600">2. 대여료 및 보증금 안내</div>
                <table className="w-full text-center text-[10px]">
                  <tr className="bg-slate-50 border-b"><th>기간</th><th>대여료</th><th>보증금</th></tr>
                  {['24M', '36M', '48M'].map(m => (
                    <tr key={m} className="border-b">
                      <td className="py-1">{m}</td>
                      <td className="text-blue-700 font-bold">{selectedCar[`금액_대여료_${m}`]}원</td>
                      <td>{selectedCar[`금액_보증금_${m}`]}원</td>
                    </tr>
                  ))}
                </table>
              </section>

              {/* 3. 보험 보상 상세 */}
              <section className="border rounded overflow-hidden">
                <div className="bg-slate-50 px-2 py-1 border-b font-bold text-slate-600">3. 보험 보상 상세</div>
                <div className="p-2 space-y-1 text-[10px]">
                   <div className="flex justify-between"><span>대인/대물</span><span>무한 / 1억원</span></div>
                   <div className="flex justify-between"><span>자차면책금</span><span className="text-rose-600 font-bold">{selectedCar.보험_최소면책금}~{selectedCar.보험_최대면책금}</span></div>
                </div>
              </section>

              {/* 4. 계약 조건 */}
              <section className="border rounded overflow-hidden">
                <div className="bg-slate-50 px-2 py-1 border-b font-bold text-slate-600">4. 계약 조건</div>
                <div className="p-2 space-y-1">
                  <div className="flex justify-between"><span>운전연령</span><span>{selectedCar.계약_기본운전연령}</span></div>
                  <div className="flex justify-between"><span>약정거리</span><span>{selectedCar.계약_약정주행거리}</span></div>
                </div>
              </section>

              {/* 5. 담당자 정보 */}
              <section className="border rounded overflow-hidden">
                <div className="bg-slate-50 px-2 py-1 border-b font-bold text-slate-600">5. 담당자 정보</div>
                <div className="p-2 space-y-2">
                  <input type="text" placeholder="소속" className="w-full p-1.5 border rounded" value={managerInfo.company} onChange={e => setManagerInfo({...managerInfo, company: e.target.value})} />
                  <input type="text" placeholder="성명/직책" className="w-full p-1.5 border rounded" value={managerInfo.nameTitle} onChange={e => setManagerInfo({...managerInfo, nameTitle: e.target.value})} />
                  <input type="text" placeholder="연락처" className="w-full p-1.5 border rounded" value={managerInfo.phone} onChange={e => setManagerInfo({...managerInfo, phone: e.target.value})} />
                </div>
              </section>
            </div>
            <div className="p-4 border-t grid grid-cols-2 gap-2">
               <button onClick={() => {}} className="py-3 border font-bold text-slate-600 hover:bg-slate-50 flex items-center justify-center gap-2"><Share2 size={14}/> 고객용 링크</button>
               <button onClick={handleCopySummary} className={`py-3 font-bold text-white flex items-center justify-center gap-2 ${copyFeedback ? 'bg-green-600' : 'bg-slate-800'}`}>
                 {copyFeedback ? <CheckCircle2 size={14}/> : <Copy size={14}/>} 텍스트 복사
               </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default App;
