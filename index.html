<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프레패스 모빌리티 ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; font-size: 11px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .sidebar-elevation { box-shadow: 4px 0 15px rgba(0, 0, 0, 0.08), 1px 0 3px rgba(0, 0, 0, 0.1); }
        .btn-pressable { box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06); transition: all 0.12s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-pressable:active { transform: translateY(1.5px); box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05); }
        .tactile-btn { box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1); transition: all 0.1s ease; }
        .tactile-btn-active { box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1) !important; transform: translateY(1px); background-color: #f8fafc; }
        .natural-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        .apply-btn-shadow { box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04); transition: all 0.1s ease; }
        .apply-btn-shadow:active { transform: translateY(1px); box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1); }
        @keyframes drawerAppear { 0% { transform: translateX(100%); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
        .animate-drawer-reset { animation: drawerAppear 0.3s cubic-bezier(0.1, 0.9, 0.2, 1) forwards; }
    </style>
</head>
<body class="bg-[#f1f3f6] text-slate-900 overflow-hidden select-none border-none">

<div id="app" class="flex h-screen overflow-hidden text-[11px]">
    <!-- 좌측 필터바 -->
    <div class="w-[72px] bg-white flex flex-col z-[60] flex-shrink-0 border-r border-slate-200 relative sidebar-elevation">
        <div class="mt-[80px] flex flex-col items-center gap-2 px-1.5" id="sidebar-btns"></div>
    </div>

    <!-- 메인 영역 -->
    <div class="flex-1 flex flex-col min-w-0 relative">
        <header class="h-[50px] bg-white border-b border-slate-200 flex items-center px-4 gap-4 flex-shrink-0 z-20 shadow-sm">
            <div class="flex items-center gap-3 flex-1 max-w-2xl">
                <div class="relative flex-1 max-w-sm">
                    <i data-lucide="search" class="absolute left-2.5 top-2.5 text-slate-400 w-4 h-4"></i>
                    <input type="text" id="searchInput" placeholder="매물 통합 검색..." class="w-full pl-9 pr-4 py-2 border border-slate-200 rounded-none text-xs focus:outline-none focus:border-slate-400 bg-white">
                </div>
                <button onclick="downloadExcel()" class="flex items-center gap-1.5 px-3 py-2 bg-[#1D6F42] text-white font-bold text-[10px] rounded-none btn-pressable">
                    <i data-lucide="download" class="w-3 h-3"></i> 엑셀 다운로드
                </button>
            </div>

            <div class="ml-auto flex items-center gap-4">
                <div class="flex items-center gap-1.5">
                    <div class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></div>
                    <span class="text-[11px] text-slate-400 font-black uppercase">데이터 서버 연동 중:</span>
                    <b id="data-count" class="text-slate-800 font-black text-[11px]">0</b>
                    <span class="text-slate-500 font-bold">건</span>
                </div>
                <div class="h-4 border-l border-slate-200"></div>
                <button onclick="fetchData()" class="flex items-center gap-1.5 px-3 py-2 bg-white border border-slate-300 font-bold text-[11px] text-slate-700 rounded-none btn-pressable">
                    <i data-lucide="rotate-cw" id="refresh-icon" class="w-3 h-3"></i> 최신화
                </button>
            </div>
        </header>

        <!-- 테이블 영역 -->
        <div class="flex-1 overflow-auto bg-white m-0 relative text-slate-800">
            <table class="w-full border-collapse text-left text-[11px] table-fixed">
                <thead class="sticky top-0 bg-[#f8f9fb] border-b border-slate-300 z-40 font-bold text-slate-600 text-center uppercase tracking-tighter">
                    <tr id="table-header" class="divide-x divide-slate-200"></tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-slate-100 text-center font-sans"></tbody>
            </table>
        </div>

        <!-- 상세 페이지 Drawer -->
        <div id="detail-drawer" class="absolute right-0 top-0 h-full w-[440px] bg-white natural-shadow z-[100] flex flex-col border-l border-slate-200 transition-transform duration-300 translate-x-full"></div>
    </div>
</div>

<!-- 팝업 오버레이 -->
<div id="popup-overlay" class="fixed inset-0 z-[70] pointer-events-none"></div>

<script>
    // --- [데이터 및 상태] ---
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vREzDg6YIAoZBiSeT58g6sksXFZkILyX0hKJeuQIdfKxWDRgu7SX7epVkuKMjXvp8n10-sNCoWRyJdJ/pub?gid=1259006970&single=true&output=csv";
    
    let rawData = [];
    let state = {
        searchTerm: "",
        selectedCar: null,
        selectedPeriods: ['36M', '48M', '60M'],
        columnFilters: {},
        sidebarFilters: { rental: [], deposit: [], mileage: [], year: [] },
        sortConfig: { key: null, direction: 'desc' },
        activeSidebarPopup: null,
        activeFilterColumn: null,
        managerInfo: {
            company: localStorage.getItem('erp_manager_company') || '',
            nameTitle: localStorage.getItem('erp_manager_nameTitle') || '',
            phone: localStorage.getItem('erp_manager_phone') || '',
            includeAccount: localStorage.getItem('erp_manager_includeAcc') === 'true'
        }
    };

    const baseColumns = { "상태": "차량_상태", "구분": "차량_구분", "차량번호": "차량_번호", "제조사": "차량_제조사", "모델": "차량_모델명", "세부모델": "차량_세부모델", "세부트림(선택옵션)": "차량_세부트림", "외부색상": "차량_외부색상", "내부색상": "차량_내부색상", "주행거리": "차량_현재주행거리" };
    const filterableColumns = ["상태", "구분", "제조사", "모델", "세부모델", "외부색상", "내부색상"];
    const sortableColumns = ["주행거리"];
    
    const rentalOptions = ['50만 이하', '50~60', '60~70', '70~80', '80~90', '90~100', '100만 이상'];
    const depositOptions = ['100만 이하', '100~200', '200~300', '300~400', '400~500', '500만 이상'];
    const mileageOptions = ['1만km 미만', '1~3만', '3~5만', '5~10만', '10만km 이상'];
    const yearOptions = ['1년 이하', '1~3년', '3~5년', '5년 이상'];

    // --- [유틸리티] ---
    const parseNum = (str) => {
        if (!str) return 0;
        const val = parseInt(String(str).replace(/[^0-9]/g, ''));
        return isNaN(val) ? 0 : val;
    };
    const formatPrice = (val) => parseNum(val).toLocaleString();
    const formatPeriod = (p) => p ? p.replace('M', '개월') : "";

    // --- [데이터 패치] ---
    async function fetchData() {
        const icon = document.getElementById('refresh-icon');
        icon.classList.add('animate-spin');
        try {
            const res = await fetch(`${CSV_URL}&cachebust=${Date.now()}`);
            const text = await res.text();
            const rows = text.split(/\r?\n/).filter(r => r.trim());
            const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
            rawData = rows.slice(1).map(row => {
                const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v ? v.trim().replace(/^"|"$/g, '').replace(/""/g, '"') : "");
                return headers.reduce((obj, header, i) => { obj[header] = values[i] || ""; return obj; }, {});
            });
            render();
        } catch (e) { console.error("Data fetch error", e); }
        icon.classList.remove('animate-spin');
    }

    // --- [필터링 및 정렬] ---
    function getProcessedData() {
        let result = rawData.filter(item => {
            const matchesSearch = Object.values(item).some(v => String(v).toLowerCase().includes(state.searchTerm.toLowerCase()));
            const matchesCol = Object.entries(state.columnFilters).every(([col, vals]) => !vals || !vals.length || vals.includes(String(item[col])));
            
            let matchesRental = true;
            if (state.sidebarFilters.rental.length > 0) {
                const pk = `금액_대여료_${state.selectedPeriods[0] || '24M'}`;
                const val = parseNum(item[pk]);
                matchesRental = state.sidebarFilters.rental.some(range => {
                    if (range === '50만 이하') return val <= 500000;
                    if (range === '100만 이상') return val >= 1000000;
                    const [low, high] = range.split('~').map(s => parseInt(s) * 10000);
                    return val >= low && val < high;
                });
            }

            let matchesMileage = true;
            if (state.sidebarFilters.mileage.length > 0) {
                const val = parseNum(item.차량_현재주행거리);
                matchesMileage = state.sidebarFilters.mileage.some(range => {
                    if (range === '1만km 미만') return val < 10000;
                    if (range === '10만km 이상') return val >= 100000;
                    if (range === '1~3만') return val >= 10000 && val < 30000;
                    if (range === '3~5만') return val >= 30000 && val < 50000;
                    if (range === '5~10만') return val >= 50000 && val < 100000;
                    return false;
                });
            }
            
            let matchesYear = true;
            if (state.sidebarFilters.year.length > 0) {
                const rawDate = item.차량_최초등록일 || item['최초등록일'] || "";
                if (!rawDate) matchesYear = false;
                else {
                    const now = new Date('2026-02-02');
                    const regDate = new Date(String(rawDate).replace(/\./g, '-'));
                    const diffDays = Math.ceil(Math.abs(now - regDate) / (1000 * 60 * 60 * 24));
                    const age = diffDays / 365;
                    matchesYear = state.sidebarFilters.year.some(r => {
                        if (r === '1년 이하') return age <= 1;
                        if (r === '1~3년') return age > 1 && age <= 3;
                        if (r === '3~5년') return age > 3 && age <= 5;
                        if (r === '5년 이상') return age > 5;
                        return false;
                    });
                }
            }

            return matchesSearch && matchesCol && matchesRental && matchesMileage && matchesYear;
        });

        if (state.sortConfig.key) {
            result.sort((a, b) => {
                let av = a[state.sortConfig.key], bv = b[state.sortConfig.key];
                if (state.sortConfig.key.includes('거리') || state.sortConfig.key.includes('금액')) { av = parseNum(av); bv = parseNum(bv); }
                return state.sortConfig.direction === 'asc' ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
            });
        }
        return result;
    }

    // --- [렌더링 엔진] ---
    function render() {
        const filtered = getProcessedData();
        document.getElementById('data-count').innerText = filtered.length;
        
        renderSidebar();
        renderHeader();
        renderTable(filtered);
        renderDetail();
        renderPopups();
        lucide.createIcons();
    }

    function renderSidebar() {
        const btns = [
            { id: 'period', label: '기간' }, { id: 'rental', label: '대여료' },
            { id: 'deposit', label: '보증금' }, { id: 'mileage', label: '주행거리' }, { id: 'year', label: '연식' }
        ];
        document.getElementById('sidebar-btns').innerHTML = btns.map(b => {
            const isActive = state.activeSidebarPopup === b.id;
            const isFiltered = b.id === 'period' ? state.selectedPeriods.length > 0 : state.sidebarFilters[b.id]?.length > 0;
            return `
                <div class="relative w-full">
                    <button onclick="toggleSidebarPopup('${b.id}')" class="w-full h-[40px] flex flex-col items-center justify-center border border-slate-100 tactile-btn ${isActive ? 'tactile-btn-active text-blue-700 bg-slate-50' : 'bg-white text-slate-700'} relative">
                        <span class="text-[10px] font-black tracking-tighter uppercase text-center leading-[1.1]">${b.label}</span>
                        ${isFiltered ? '<div class="absolute top-1 right-1 w-1.5 h-1.5 bg-blue-600 rounded-full border border-white"></div>' : ''}
                    </button>
                </div>
            `;
        }).join('');
    }

    function renderHeader() {
        let html = '';
        Object.entries(baseColumns).forEach(([label, key]) => {
            const isSorted = state.sortConfig.key === key;
            const isFiltered = state.columnFilters[key]?.length > 0;
            html += `
                <th class="py-2 px-1 relative transition-colors border-b border-slate-200 ${isSorted ? 'bg-blue-50' : ''}">
                    <div class="flex flex-row items-center justify-center gap-1 leading-tight h-full">
                        <span class="${isSorted || isFiltered ? 'text-blue-700 font-black' : ''} truncate">${label}</span>
                        ${filterableColumns.includes(label) ? `<button onclick="toggleColFilter('${key}')" class="p-0.5 ${isFiltered ? 'text-blue-700' : 'text-slate-300'}"><i data-lucide="filter" class="w-2.5 h-2.5"></i></button>` : ''}
                        ${sortableColumns.includes(label) ? `<button onclick="handleSort('${key}')" class="p-0.5 ${isSorted ? 'text-blue-700' : 'text-slate-300'}"><i data-lucide="arrow-up-down" class="w-2.5 h-2.5"></i></button>` : ''}
                    </div>
                </th>
            `;
        });
        state.selectedPeriods.forEach(p => {
            const isSorted = state.sortConfig.key === `금액_대여료_${p}`;
            html += `
                <th class="py-2 px-1 relative w-[105px] bg-blue-50 border-l border-blue-100 text-blue-800 ${isSorted ? 'bg-blue-100' : ''}">
                    <div class="flex flex-col items-center font-black">
                        <span class="text-[10px] uppercase">${formatPeriod(p)} 대여료</span>
                        <span class="text-[9px] opacity-70 font-bold">(보증금)</span>
                    </div>
                </th>
            `;
        });
        document.getElementById('table-header').innerHTML = html;
    }

    function renderTable(data) {
        document.getElementById('table-body').innerHTML = data.map(item => `
            <tr onclick="handleCarClick('${item.차량_번호}')" class="hover:bg-slate-50 cursor-pointer divide-x divide-slate-50 h-[52px] transition-colors ${state.selectedCar?.차량_번호 === item.차량_번호 ? 'bg-blue-50 font-bold' : ''}">
                <td class="p-2"><span class="px-1.5 py-0.5 border text-[10px] font-black rounded-none ${item.차량_상태.includes('가능') ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-amber-50 text-amber-700 border-amber-100'}">${item.차량_상태}</span></td>
                <td class="p-2"><span class="px-1.5 py-0.5 border text-[10px] font-black rounded-none ${item.차량_구분 === '신차' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-slate-100 text-slate-700 border-slate-200'}">${item.차량_구분}</span></td>
                <td class="p-2 truncate font-bold text-slate-900 text-center">${item.차량_번호}</td>
                <td class="p-2 truncate text-slate-700 font-medium text-center">${item.차량_제조사}</td>
                <td class="p-2 truncate font-black text-center text-slate-900">${item.차량_모델명}</td>
                <td class="p-2 truncate text-slate-500 text-left font-medium">${item.차량_세부모델}</td>
                <td class="p-2 text-left leading-none">
                    <div class="font-bold text-slate-800 truncate">${item.차량_세부트림}</div>
                    <div class="text-slate-400 font-normal text-[9px] truncate mt-1">${item.차량_선택옵션 || '옵션없음'}</div>
                </td>
                <td class="p-2 truncate text-slate-500 text-center">${item.차량_외부색상}</td>
                <td class="p-2 truncate text-slate-500 text-center">${item.차량_내부색상}</td>
                <td class="p-2 truncate text-right font-bold text-slate-700 pr-6">${item.차량_현재주행거리}km</td>
                ${state.selectedPeriods.map(p => `
                    <td class="p-2 bg-blue-50/30 text-blue-800 font-black text-right pr-6 leading-none">
                        <div class="text-[12px]">${item[`금액_대여료_${p}`] || '-'}</div>
                        <div class="text-slate-400 font-bold text-[9px] mt-1">${item[`금액_보증금_${p}`] || '-'}</div>
                    </td>
                `).join('')}
            </tr>
        `).join('');
    }

    function renderDetail() {
        const drawer = document.getElementById('detail-drawer');
        if (!state.selectedCar) { drawer.classList.add('translate-x-full'); return; }
        const c = state.selectedCar;
        drawer.classList.remove('translate-x-full');
        drawer.classList.add('animate-drawer-reset');

        drawer.innerHTML = `
            <div class="h-[50px] flex justify-between items-center px-4 bg-white border-b border-slate-100 text-slate-800 flex-shrink-0">
                <h2 class="font-black text-[12px] tracking-widest uppercase flex items-center gap-2"><i data-lucide="car"></i> 상품 상세 정보</h2>
                <button onclick="closeDetail()" class="text-slate-400 hover:text-slate-800 p-1"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-3 space-y-3 bg-white text-[11px] text-slate-800">
                <!-- 1. 차량 상세 제원 -->
                <section class="border border-slate-200 shadow-sm">
                    <div class="bg-slate-50 px-3 py-2 border-b font-black text-slate-600 uppercase">1. 차량 상세 제원</div>
                    <div class="p-3 space-y-3.5">
                        <div class="flex items-center justify-between pb-2 border-b border-slate-100">
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="font-black text-[12px] text-blue-700 tracking-tight">${c.차량_번호}</span>
                                <span class="font-black text-[12px] text-slate-900">${c.차량_제조사} ${c.차량_모델명}</span>
                                <span class="font-bold text-[11px] text-slate-500">${c.차량_연료}</span>
                            </div>
                        </div>
                        <div class="space-y-1.5">
                            <div class="flex gap-2"><span class="text-slate-400 font-bold w-[60px] flex-shrink-0 text-[10px]">세부모델</span><span class="font-black text-slate-900">${c.차량_세부모델}</span></div>
                            <div class="flex gap-2"><span class="text-slate-400 font-bold w-[60px] flex-shrink-0 text-[10px]">세부트림</span><span class="font-black text-blue-700">${c.차량_세부트림}</span></div>
                            <div class="flex gap-2"><span class="text-slate-400 font-bold w-[60px] flex-shrink-0 text-[10px]">선택옵션</span><span class="font-medium text-slate-600 leading-tight">${c.차량_선택옵션 || '기본 사양'}</span></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 border-t pt-3">
                            <div class="flex justify-between"><span class="text-slate-400 font-bold text-[10px]">주행거리</span><span class="font-black text-blue-700">${formatPrice(c.차량_현재주행거리)}km</span></div>
                            <div class="flex justify-between"><span class="text-slate-400 font-bold text-[10px]">배기량</span><span class="font-black">${c.차량_배기량 ? formatPrice(c.차량_배기량)+'cc' : '-'}</span></div>
                            <div class="flex justify-between"><span class="text-slate-400 font-bold text-[10px]">최초등록</span><span class="font-black">${c.차량_최초등록일}</span></div>
                            <div class="flex justify-between"><span class="text-slate-400 font-bold text-[10px]">차령만료</span><span class="font-black text-rose-600">${c.차량_차령만료일 || '-'}</span></div>
                        </div>
                        <button onclick="window.open('${c.차량_사진링크}','_blank')" class="w-full py-3 bg-white border border-slate-300 font-black text-[10px] uppercase apply-btn-shadow">차량 사진 확인 (링크)</button>
                    </div>
                </section>

                <!-- 2. 대여료 및 보증금 안내 -->
                <section class="border border-slate-200">
                    <div class="bg-slate-50 px-3 py-2 border-b font-black text-slate-600 uppercase">2. 대여료 및 보증금 안내</div>
                    <table class="w-full text-center text-[11px]">
                        <thead class="bg-[#f8f9fb] border-b font-bold text-slate-500 uppercase">
                            <tr><th class="py-2">계약기간</th><th class="py-2 text-blue-800 text-right pr-4">월 대여료</th><th class="py-2 text-right pr-4">보증금</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100 font-medium">
                            ${['6M', '12M', '24M', '36M', '48M', '60M'].map(m => {
                                const fee = c[`금액_대여료_${m}`];
                                if (!fee || fee === '-' || fee === '0') return '';
                                return `<tr class="divide-x"><td class="py-2 font-black uppercase">${formatPeriod(m)}</td><td class="py-2 text-blue-800 font-black text-right pr-4">${fee}원</td><td class="py-2 text-slate-500 text-right pr-4">${c[`금액_보증금_${m}`]}원</td></tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </section>

                <!-- 3. 보험 보상 상세 -->
                <section class="border border-slate-200">
                    <div class="bg-slate-50 px-3 py-2 border-b font-black text-slate-600 uppercase">3. 보험 보상 상세</div>
                    <table class="w-full text-[10px]">
                        <tbody class="divide-y divide-slate-100 font-bold uppercase">
                            <tr class="divide-x"><td class="p-2 text-left text-slate-500">대인배상</td><td class="p-2 text-center">${c.보험_대인 || '무한'}</td><td class="p-2 text-right text-blue-800 pr-4">${c.보험_대인면책금 || '0원'}</td></tr>
                            <tr class="divide-x"><td class="p-2 text-left text-slate-500">대물배상</td><td class="p-2 text-center">${c.보험_대물 || '1억원'}</td><td class="p-2 text-right text-blue-800 pr-4">${c.보험_대물면책금 || '10만'}</td></tr>
                            <tr class="divide-x bg-blue-50/20"><td class="p-2 text-left text-slate-500">자기차량(자차)</td><td class="p-2 text-center">차량가액 한도</td><td class="p-2 text-right text-rose-700 pr-4">수리비 20% (${c.보험_최소면책금 || '20만'}~${c.보험_최대면책금 || '50만'})</td></tr>
                        </tbody>
                    </table>
                    <div class="p-2.5 bg-rose-50 text-[10px] text-rose-700 font-black border-t border-rose-100 uppercase">1년 미만 운전자 면책금 30만원 추가 할증 적용</div>
                </section>

                <!-- 4. 계약 및 추가 비용 -->
                <section class="border border-slate-200">
                    <div class="bg-slate-50 px-3 py-2 border-b font-black text-slate-600 uppercase">4. 계약 정책 및 연령/거리 옵션</div>
                    <div class="grid grid-cols-2 divide-x border-b">
                        <div class="p-2.5 flex justify-between"><span class="text-slate-400 font-bold uppercase text-[9px]">기본연령</span><span class="font-black">${c.계약_기본운전연령 || '만 26세'}</span></div>
                        <div class="p-2.5 flex justify-between"><span class="text-slate-400 font-bold uppercase text-[9px]">약정거리</span><span class="font-black">${c.계약_약정주행거리 || '2만km'}</span></div>
                    </div>
                    <div class="divide-y font-bold">
                        <div class="flex justify-between p-2.5 hover:bg-slate-50"><span>만 21세 연령 하향</span><span class="text-blue-700">${parseNum(c.계약_21세추가금)>0 ? '+'+formatPrice(c.계약_21세추가금)+'원/월' : '운영안함'}</span></div>
                        <div class="flex justify-between p-2.5 hover:bg-slate-50"><span>연간 1만km 거리 추가</span><span class="text-blue-700">+${formatPrice(c.계약_주행거리추가금)}원/월</span></div>
                    </div>
                </section>

                <!-- 5. 담당자 및 입금 계좌 -->
                <section class="border border-slate-200">
                    <div class="bg-slate-50 px-3 py-2 border-b font-black text-slate-600 uppercase">5. 담당자 및 입금 계좌 안내</div>
                    <div class="p-3 space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="mgr-co" placeholder="소속" oninput="updateManagerInfo()" value="${state.managerInfo.company}" class="p-2 border font-bold">
                            <input type="text" id="mgr-nt" placeholder="성명/직책" oninput="updateManagerInfo()" value="${state.managerInfo.nameTitle}" class="p-2 border font-bold">
                            <input type="text" id="mgr-ph" placeholder="연락처" oninput="updateManagerInfo()" value="${state.managerInfo.phone}" class="p-2 border font-bold col-span-2">
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="mgr-acc" onchange="updateManagerInfo()" ${state.managerInfo.includeAccount ? 'checked' : ''} class="w-4 h-4 accent-slate-800">
                            <span class="font-black">입금 계좌 정보 포함하기</span>
                        </label>
                        ${state.managerInfo.includeAccount ? `<div class="p-3 bg-blue-50 border border-blue-100 text-center"><p class="font-black text-blue-800 tracking-tighter">우리은행: ${c.계약_입금계좌번호 || '미등록'}</p></div>` : ''}
                    </div>
                </section>
            </div>
            <div class="p-3 border-t bg-white grid grid-cols-2 gap-3">
                <button onclick="copyLink()" class="py-3.5 bg-white border border-slate-300 text-slate-800 font-black text-[11px] uppercase tracking-widest apply-btn-shadow">고객용 링크</button>
                <button onclick="copySummary()" class="py-3.5 bg-slate-800 text-white font-black text-[11px] uppercase tracking-widest apply-btn-shadow">전달용 텍스트</button>
            </div>
        `;
        lucide.createIcons();
    }

    // --- [팝업 처리] ---
    function renderPopups() {
        const overlay = document.getElementById('popup-overlay');
        overlay.innerHTML = '';
        overlay.classList.remove('pointer-events-auto');
        overlay.classList.add('pointer-events-none');

        if (state.activeSidebarPopup) {
            overlay.classList.remove('pointer-events-none');
            overlay.classList.add('pointer-events-auto');
            const id = state.activeSidebarPopup;
            const label = id==='period'?'기간':id==='rental'?'대여료':id==='deposit'?'보증금':id==='mileage'?'주행거리':'연식';
            const opts = id==='period'?['6M','12M','24M','36M','48M','60M']:id==='rental'?rentalOptions:id==='deposit'?depositOptions:id==='mileage'?mileageOptions:yearOptions;
            
            const btnRect = document.querySelector(`button[onclick*="${id}"]`).getBoundingClientRect();
            
            const popup = document.createElement('div');
            popup.className = `absolute bg-white border border-slate-200 natural-shadow z-[100] w-[210px] rounded-none overflow-hidden flex flex-col`;
            popup.style.left = `80px`;
            popup.style.top = `${Math.min(btnRect.top, window.innerHeight - 300)}px`;
            
            popup.innerHTML = `
                <div class="p-3 border-b bg-slate-50 flex justify-between items-center">
                    <span class="text-[11px] font-black text-slate-500 uppercase">${label} 필터</span>
                    <button onclick="toggleSidebarPopup(null)" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div class="max-h-64 overflow-y-auto p-1.5 hide-scrollbar bg-white">
                    ${opts.map(opt => `
                        <label class="flex items-center gap-2.5 p-2.5 hover:bg-slate-50 cursor-pointer transition-colors group">
                            <input type="checkbox" onchange="toggleSidebarFilter('${id}', '${opt}')" ${id==='period'?state.selectedPeriods.includes(opt):state.sidebarFilters[id].includes(opt) ? 'checked' : ''} class="w-3.5 h-3.5 accent-slate-800">
                            <span class="font-bold text-slate-600 group-hover:text-slate-900">${id==='period'?formatPeriod(opt):opt}</span>
                        </label>
                    `).join('')}
                </div>
                <div class="p-3 border-t bg-white">
                    <button onclick="toggleSidebarPopup(null)" class="w-full py-2.5 bg-white border border-slate-200 text-slate-800 font-black text-[11px] uppercase tracking-widest apply-btn-shadow">적용하기</button>
                </div>
            `;
            overlay.appendChild(popup);
        }
    }

    // --- [이벤트 핸들러] ---
    window.fetchData = fetchData;
    window.handleCarClick = (no) => {
        state.selectedCar = (state.selectedCar?.차량_번호 === no) ? null : rawData.find(c => c.차량_번호 === no);
        render();
    };
    window.closeDetail = () => { state.selectedCar = null; render(); };
    window.toggleSidebarPopup = (id) => { state.activeSidebarPopup = (state.activeSidebarPopup === id) ? null : id; render(); };
    window.toggleSidebarFilter = (key, val) => {
        if (key === 'period') {
            state.selectedPeriods = state.selectedPeriods.includes(val) ? state.selectedPeriods.filter(x => x !== val) : [...state.selectedPeriods, val].sort();
        } else {
            const current = state.sidebarFilters[key];
            state.sidebarFilters[key] = current.includes(val) ? current.filter(x => x !== val) : [...current, val];
        }
        render();
    };
    window.handleSort = (key) => {
        if (state.sortConfig.key === key) {
            state.sortConfig.direction = state.sortConfig.direction === 'desc' ? 'asc' : 'desc';
        } else {
            state.sortConfig = { key, direction: 'desc' };
        }
        render();
    };
    window.updateManagerInfo = () => {
        state.managerInfo.company = document.getElementById('mgr-co').value;
        state.managerInfo.nameTitle = document.getElementById('mgr-nt').value;
        state.managerInfo.phone = document.getElementById('mgr-ph').value;
        state.managerInfo.includeAccount = document.getElementById('mgr-acc').checked;
        localStorage.setItem('erp_manager_company', state.managerInfo.company);
        localStorage.setItem('erp_manager_nameTitle', state.managerInfo.nameTitle);
        localStorage.setItem('erp_manager_phone', state.managerInfo.phone);
        localStorage.setItem('erp_manager_includeAcc', String(state.managerInfo.includeAccount));
        renderDetail(); // 즉시 반영을 위해 부분 렌더링
    };

    window.copySummary = () => {
        const c = state.selectedCar;
        const text = `[상품 정보]\n번호: ${c.차량_번호}\n모델: ${c.차량_제조사} ${c.차량_모델명}\n대여료: ${c['금액_대여료_36M'] || '-'}\n담당자: ${state.managerInfo.company} ${state.managerInfo.nameTitle}\n연락처: ${state.managerInfo.phone}`;
        navigator.clipboard.writeText(text).then(() => alert("복사되었습니다."));
    };

    window.copyLink = () => {
        const url = window.location.href + "?car=" + state.selectedCar.차량_번호;
        navigator.clipboard.writeText(url).then(() => alert("링크가 복사되었습니다."));
    };

    window.downloadExcel = () => {
        const headers = ["상태", "구분", "차량번호", "제조사", "모델", "주행거리"];
        const rows = rawData.map(c => [c.차량_상태, c.차량_구분, c.차량_번호, c.차량_제조사, c.차량_모델명, c.차량_현재주행거리]);
        let csv = "\uFEFF" + headers.join(",") + "\n" + rows.map(r => r.join(",")).join("\n");
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "매물리스트.csv";
        link.click();
    };

    document.getElementById('searchInput').oninput = (e) => { state.searchTerm = e.target.value; render(); };

    // 초기 구동
    window.onload = fetchData;
</script>
</body>
</html>
