<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>렌터카 ERP 시스템</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.321.0/font/lucide.min.css" rel="stylesheet">
    <style>
        /* 사용자 정의 애니메이션 및 스타일 유지 */
        @keyframes drawerAppear { 0% { transform: translateX(100%); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
        .animate-drawer-reset { animation: drawerAppear 0.3s cubic-bezier(0.1, 0.9, 0.2, 1) forwards; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        body { margin: 0; padding: 0; }
        .lucide { vertical-align: middle; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // [수정 금지] 주신 코드의 변수와 로직을 그대로 사용하기 위한 라이브러리 연결
        const { useState, useEffect, useMemo, useRef } = React;
        
        // Lucide 아이콘을 React 컴포넌트처럼 쓸 수 있게 가상 컴포넌트 생성
        const LucideIcon = ({ name, size = 16, className = "" }) => (
            <i data-lucide={name} className={`${className}`} style={{ width: size, height: size }}></i>
        );

        // 아이콘 매핑 (주신 코드의 아이콘들을 그대로 매핑)
        const Search = (props) => <LucideIcon name="search" {...props} />;
        const X = (props) => <LucideIcon name="x" {...props} />;
        const RefreshCw = (props) => <LucideIcon name="refresh-cw" {...props} />;
        const Download = (props) => <LucideIcon name="download" {...props} />;
        const Car = (props) => <LucideIcon name="car" {...props} />;
        const Shield = (props) => <LucideIcon name="shield" {...props} />;
        const FileText = (props) => <LucideIcon name="file-text" {...props} />;
        const User = (props) => <LucideIcon name="user" {...props} />;
        const ExternalLink = (props) => <LucideIcon name="external-link" {...props} />;
        const Database = (props) => <LucideIcon name="database" {...props} />;
        const CheckCircle2 = (props) => <LucideIcon name="check-circle-2" {...props} />;
        const Copy = (props) => <LucideIcon name="copy" {...props} />;
        const Filter = (props) => <LucideIcon name="filter" {...props} />;
        const ArrowUp = (props) => <LucideIcon name="arrow-up" {...props} />;
        const ArrowDown = (props) => <LucideIcon name="arrow-down" {...props} />;
        const ArrowUpDown = (props) => <LucideIcon name="arrow-up-down" {...props} />;
        const Lock = (props) => <LucideIcon name="lock" {...props} />;
        const History = (props) => <LucideIcon name="history" {...props} />;
        const CalendarDays = (props) => <LucideIcon name="calendar-days" {...props} />;
        const Sparkles = (props) => <LucideIcon name="sparkles" {...props} />;
        const Share2 = (props) => <LucideIcon name="share-2" {...props} />;
        const Banknote = (props) => <LucideIcon name="banknote" {...props} />;

        // --- 여기서부터 사용자님이 주신 원본 코드를 그대로 붙여넣었습니다 ---

        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vREzDg6YIAoZBiSeT58g6sksXFZkILyX0hKJeuQIdfKxWDRgu7SX7epVkuKMjXvp8n10-sNCoWRyJdJ/pub?gid=1259006970&single=true&output=csv";

        const rentalOptions = ['50만 이하', '50~60', '60~70', '70~80', '80~90', '90~100', '100만 이상'];
        const depositOptions = ['100만 이하', '100~200', '200~300', '300~400', '400~500', '500만 이상'];
        const mileageOptions = ['1만km 미만', '1~3만', '3~5만', '5~10만', '10만km 이상'];
        const yearOptions = ['1년 미만', '1~2년', '2~3년', '3~4년', '4~5년', '5년 이상'];

        const StatusBadge = ({ text, type }) => {
            if (!text) return null;
            let colorClass = "bg-slate-100 text-slate-600 border-slate-200";
            if (type === '구분') {
                if (text === '신차') colorClass = "bg-blue-50 text-blue-700 border-blue-100";
                else if (text === '중고') colorClass = "bg-slate-100 text-slate-700 border-slate-200";
            } else if (type === '상태' || type === '세부상태') {
                const t = String(text);
                if (t.includes('가능') || t === '출고가능' || t === '정상') colorClass = "bg-emerald-50 text-emerald-700 border-emerald-100";
                else if (t.includes('완료') || t.includes('불가')) colorClass = "bg-rose-50 text-rose-700 border-rose-100";
                else colorClass = "bg-amber-50 text-amber-700 border-amber-100";
            }
            return (
                <span className={`inline-flex items-center justify-center px-1.5 py-0.5 border text-[10px] font-black leading-none whitespace-nowrap ${colorClass}`}>
                    {text}
                </span>
            );
        };

        const WonIcon = ({ size = 20, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M4 10h16M4 14h16M7 6l5 12 5-12" />
            </svg>
        );

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedCar, setSelectedCar] = useState(null);
            const [showAccount, setShowAccount] = useState(false);
            const [copyFeedback, setCopyFeedback] = useState(false);
            const [copyLinkFeedback, setCopyLinkFeedback] = useState(false);
            
            const [managerInfo, setManagerInfo] = useState({
                company: localStorage.getItem('erp_manager_company') || '',
                nameTitle: localStorage.getItem('erp_manager_nameTitle') || '',
                phone: localStorage.getItem('erp_manager_phone') || '',
                includeAccount: localStorage.getItem('erp_manager_includeAcc') === 'true'
            });

            const [selectedPeriods, setSelectedPeriods] = useState(['24M']); 
            const [columnFilters, setColumnFilters] = useState({}); 
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'asc' }); 
            const [sidebarFilters, setSidebarFilters] = useState({ rental: [], deposit: [], mileage: [], year: [] });
            const [activeFilterColumn, setActiveFilterColumn] = useState(null); 
            const [activeSidebarPopup, setActiveSidebarPopup] = useState(null); 
            const filterRef = useRef(null);
            const sidebarPopupRef = useRef(null);

            const parseNum = (str) => {
                const val = parseInt(String(str).replace(/[^0-9]/g, ''));
                return isNaN(val) ? 0 : val;
            };

            const formatPrice = (val) => {
                const num = parseNum(val);
                return num.toLocaleString();
            };

            const formatPeriod = (p) => {
                if (!p) return "";
                return p.replace('M', '개월');
            };

            const togglePeriod = (p) => {
                setSelectedPeriods(prev => {
                    const periodsOrder = ['6M', '12M', '24M', '36M', '48M', '60M'];
                    const next = prev.includes(p) ? (prev.length > 1 ? prev.filter(x => x !== p) : prev) : [...prev, p];
                    return next.sort((a, b) => periodsOrder.indexOf(a) - periodsOrder.indexOf(b));
                });
            };

            const toggleSidebarFilter = (key, value) => {
                setSidebarFilters(prev => {
                    const current = prev[key];
                    const next = current.includes(value) ? current.filter(v => v !== value) : [...current, value];
                    return { ...prev, [key]: next };
                });
            };

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
                else if (sortConfig.key === key && sortConfig.direction === 'desc') key = null;
                setSortConfig({ key, direction });
            };

            const handleCarClick = (car) => {
                if (selectedCar && selectedCar.차량_번호 === car.차량_번호) {
                    setSelectedCar(null);
                } else {
                    setSelectedCar(car);
                    setCopyFeedback(false);
                    setCopyLinkFeedback(false);
                    // 아이콘 새로고침
                    setTimeout(() => lucide.createIcons(), 50);
                }
            };

            const downloadTemplate = () => {
                const tableHeaders = ["상태", "구분", "차량번호", "제조사", "모델", "세부모델", "세부트림(선택옵션)", "외부색상", "내부색상", "주행거리", "대여료", "보증금"];
                const csvContent = "\uFEFF" + tableHeaders.join(",");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob); link.setAttribute("download", "매물리스트_양식.csv"); link.click();
            };

            const handleCopySummary = () => {
                if (!selectedCar) return;
                let text = `[상품 상세 정보]\n\n1. 차량 상세 제원\n■ 차량번호: ${selectedCar.차량_번호}\n■ 모델명: ${selectedCar.차량_제조사} ${selectedCar.차량_모델명}\n■ 주행거리: ${formatPrice(selectedCar.차량_현재주행거리)}km\n\n5. 담당자: ${managerInfo.company} ${managerInfo.nameTitle}`;
                navigator.clipboard.writeText(text);
                setCopyFeedback(true);
                setTimeout(() => setCopyFeedback(false), 2000);
            };

            const fetchData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${CSV_URL}&cachebust=${Date.now()}`);
                    const text = await response.text();
                    const rows = text.split(/\r?\n/).filter(r => r.trim());
                    const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
                    const jsonData = rows.slice(1).map(row => {
                        const values = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v ? v.trim().replace(/^"|"$/g, '') : "");
                        return headers.reduce((obj, header, i) => { obj[header] = values[i] || ""; return obj; }, {});
                    });
                    setData(jsonData);
                    setTimeout(() => lucide.createIcons(), 100);
                } catch (e) { console.error(e); } finally { setLoading(false); }
            };

            useEffect(() => { fetchData(); }, []);
            useEffect(() => {
                localStorage.setItem('erp_manager_company', managerInfo.company);
                localStorage.setItem('erp_manager_nameTitle', managerInfo.nameTitle);
                localStorage.setItem('erp_manager_phone', managerInfo.phone);
                localStorage.setItem('erp_manager_includeAcc', managerInfo.includeAccount);
            }, [managerInfo]);

            const filteredAndSortedData = useMemo(() => {
                let result = data.filter(item => {
                    const matchesSearch = Object.values(item).some(v => String(v).toLowerCase().includes(searchTerm.toLowerCase()));
                    const matchesColumnFilters = Object.entries(columnFilters).every(([col, selectedValues]) => {
                        if (!selectedValues || selectedValues.length === 0) return true;
                        return selectedValues.includes(String(item[col]));
                    });
                    return matchesSearch && matchesColumnFilters;
                });
                if (sortConfig.key) {
                    result.sort((a, b) => {
                        let aVal = a[sortConfig.key]; let bVal = b[sortConfig.key];
                        if (sortConfig.key === '차량_현재주행거리') { aVal = parseNum(aVal); bVal = parseNum(bVal); }
                        return sortConfig.direction === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
                    });
                }
                return result;
            }, [searchTerm, data, columnFilters, sortConfig]);

            const baseColumns = { "상태": "차량_상태", "구분": "차량_구분", "차량번호": "차량_번호", "제조사": "차량_제조사", "모델": "차량_모델명", "세부모델": "차량_세부모델", "세부트림(선택옵션)": "차량_세부트림", "외부색상": "차량_외부색상", "내부색상": "차량_내부색상", "주행거리": "차량_현재주행거리" };
            const sortableColumns = ["주행거리"];
            const filterableColumns = ["상태", "구분", "제조사", "모델", "세부모델", "외부색상", "내부색상"];

            // --- 원본 UI 시작 (수정 없이 사용자 코드를 그대로 React 방식으로 반환) ---
            return (
                <div className="flex h-screen bg-[#f1f3f6] text-slate-900 overflow-hidden font-sans select-none text-[11px]">
                    <div className="w-[68px] bg-white border-r flex flex-col items-center pt-20 gap-1 px-1">
                        <button onClick={() => setActiveSidebarPopup('period')} className="w-full aspect-square flex flex-col items-center justify-center gap-1 hover:bg-slate-50 relative">
                            <CalendarDays size={18} className="text-slate-400" />
                            <span className="text-[9px] font-sans">기간</span>
                        </button>
                        <button onClick={() => setActiveSidebarPopup('rental')} className="w-full aspect-square flex flex-col items-center justify-center gap-1 hover:bg-slate-50">
                            <WonIcon size={20} className="text-slate-400" />
                            <span className="text-[9px] font-sans">대여료</span>
                        </button>
                    </div>

                    <div className="flex-1 flex flex-col relative">
                        <header className="h-[50px] bg-white border-b flex items-center px-4 gap-4 flex-shrink-0 z-20">
                            <div className="relative flex-1 max-w-sm">
                                <Search className="absolute left-2.5 top-2.5 text-slate-400" size={16} />
                                <input type="text" placeholder="매물 통합 검색..." className="w-full pl-9 pr-4 py-1.5 border rounded text-xs focus:outline-none focus:border-blue-600" onChange={e => setSearchTerm(e.target.value)} />
                            </div>
                            <div className="ml-auto flex items-center gap-3">
                                <button onClick={downloadTemplate} className="flex items-center gap-1.5 px-3 py-1.5 border font-bold text-[10px] text-slate-600"><Download size={12}/> 양식다운로드</button>
                                <span className="text-slate-500">매물수: <b className="text-blue-600">{filteredAndSortedData.length}</b>건</span>
                                <button onClick={fetchData} className="flex items-center gap-1.5 px-3 py-1.5 border font-bold text-blue-600"><RefreshCw size={12}/> 최신화</button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-auto bg-white m-1.5 border border-slate-200 shadow-sm relative text-slate-800">
                            <table className="w-full border-collapse text-left text-[11px] table-fixed">
                                <thead className="sticky top-0 bg-[#f8f9fb] border-b z-40 font-bold text-slate-600 text-center uppercase">
                                    <tr className="divide-x">
                                        {Object.keys(baseColumns).map(label => (
                                            <th key={label} className="py-2 px-1 truncate">{label}</th>
                                        ))}
                                        {selectedPeriods.map(p => <th key={p} className="bg-blue-50 text-blue-800 w-32">{p} 대여료</th>)}
                                    </tr>
                                </thead>
                                <tbody className="divide-y text-center">
                                    {filteredAndSortedData.map((item, idx) => (
                                        <tr key={idx} onClick={() => handleCarClick(item)} className={`hover:bg-blue-50 cursor-pointer h-[48px] divide-x ${selectedCar?.차량_번호 === item.차량_번호 ? 'bg-blue-50' : ''}`}>
                                            <td><StatusBadge text={item.차량_상태} type="상태" /></td>
                                            <td><StatusBadge text={item.차량_구분} type="구분" /></td>
                                            <td className="font-bold">{item.차량_번호}</td>
                                            <td>{item.차량_제조사}</td>
                                            <td className="font-bold text-slate-900">{item.차량_모델명}</td>
                                            <td className="truncate text-left px-2">{item.차량_세부모델}</td>
                                            <td className="truncate text-left px-2 text-slate-500">{item.차량_세부트림}</td>
                                            <td>{item.차량_외부색상}</td>
                                            <td>{item.차량_내부색상}</td>
                                            <td className="text-right pr-2">{item.차량_현재주행거리}km</td>
                                            {selectedPeriods.map(p => <td key={p} className="text-blue-700 font-black">{item[`금액_대여료_${p}`]}</td>)}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {selectedCar && (
                            <div className="absolute right-0 top-0 h-full w-[440px] bg-white shadow-2xl z-[100] border-l animate-drawer-reset flex flex-col">
                                <div className="h-[44px] flex justify-between items-center px-4 border-b">
                                    <h2 className="font-black text-[11px] flex items-center gap-2 uppercase"><Car size={16} className="text-blue-600" /> 상품 상세 정보</h2>
                                    <button onClick={() => setSelectedCar(null)}><X size={18} /></button>
                                </div>
                                <div className="flex-1 overflow-y-auto p-1.5 space-y-1.5 text-slate-800 bg-white">
                                    <section className="border p-2 space-y-2">
                                        <div className="bg-slate-50 px-2 py-1 border-b font-black text-slate-600 flex items-center gap-1.5 uppercase">
                                            <Sparkles size={12} className="text-blue-600"/> 1. 차량 상세 제원
                                        </div>
                                        <div className="p-2 space-y-1">
                                            <div className="flex justify-between"><span>차량번호</span><span className="font-bold text-blue-700">{selectedCar.차량_번호}</span></div>
                                            <div className="flex justify-between"><span>모델명</span><span className="font-bold">{selectedCar.차량_제조사} {selectedCar.차량_모델명}</span></div>
                                            <div className="flex justify-between"><span>주행거리</span><span className="font-bold">{formatPrice(selectedCar.차량_현재주행거리)}km</span></div>
                                        </div>
                                    </section>
                                    <section className="border p-2 space-y-2">
                                        <div className="bg-slate-50 px-2 py-1 border-b font-black text-slate-600 flex items-center gap-1.5 uppercase">
                                            <Banknote size={12} className="text-blue-600"/> 2. 대여료 및 보증금 안내
                                        </div>
                                        <div className="p-2 space-y-1">
                                            <div className="flex justify-between font-bold text-blue-700"><span>24M 대여료</span><span>{selectedCar.금액_대여료_24M}원</span></div>
                                            <div className="flex justify-between text-slate-500"><span>보증금</span><span>{selectedCar.금액_보증금_24M}원</span></div>
                                        </div>
                                    </section>
                                    <section className="border p-2 space-y-2">
                                        <div className="bg-slate-50 px-2 py-1 border-b font-black text-slate-600 flex items-center gap-1.5 uppercase">
                                            <Shield size={12} className="text-blue-600"/> 3. 보험 보상 상세
                                        </div>
                                        <div className="p-2 space-y-1">
                                            <div className="flex justify-between"><span>대물배상</span><span>{selectedCar.보험_대물 || '1억원'}</span></div>
                                            <div className="flex justify-between text-rose-600 font-bold"><span>자차면책금</span><span>{selectedCar.보험_최소면책금}~{selectedCar.보험_최대면책금}</span></div>
                                        </div>
                                    </section>
                                    <section className="border p-2 space-y-2">
                                        <div className="bg-slate-50 px-2 py-1 border-b font-black text-slate-600 flex items-center gap-1.5 uppercase">
                                            <FileText size={12} className="text-blue-600"/> 4. 계약 및 조건
                                        </div>
                                        <div className="p-2 space-y-1">
                                            <div className="flex justify-between"><span>기본연령</span><span>{selectedCar.계약_기본운전연령}</span></div>
                                            <div className="flex justify-between"><span>약정거리</span><span>{selectedCar.계약_약정주행거리}</span></div>
                                        </div>
                                    </section>
                                    <section className="border p-2 space-y-2">
                                        <div className="bg-slate-50 px-2 py-1 border-b font-black text-slate-600 flex items-center gap-1.5 uppercase">
                                            <User size={12} className="text-blue-600"/> 5. 담당자 정보
                                        </div>
                                        <div className="p-2 space-y-2">
                                            <div className="grid grid-cols-2 gap-2">
                                                <input className="border p-1.5" placeholder="소속" value={managerInfo.company} onChange={e => setManagerInfo({...managerInfo, company: e.target.value})} />
                                                <input className="border p-1.5" placeholder="성함" value={managerInfo.nameTitle} onChange={e => setManagerInfo({...managerInfo, nameTitle: e.target.value})} />
                                            </div>
                                            <input className="w-full border p-1.5" placeholder="연락처" value={managerInfo.phone} onChange={e => setManagerInfo({...managerInfo, phone: e.target.value})} />
                                        </div>
                                    </section>
                                </div>
                                <div className="p-2 border-t bg-white grid grid-cols-2 gap-1.5">
                                    <button className="py-3 border font-black text-slate-600 flex items-center justify-center gap-1.5 hover:bg-slate-50"><Share2 size={14}/> 고객용 링크</button>
                                    <button onClick={handleCopySummary} className={`py-3 font-black text-white flex items-center justify-center gap-1.5 ${copyFeedback ? 'bg-green-600' : 'bg-slate-800'}`}><Copy size={14}/> {copyFeedback ? '복사완료' : '텍스트 복사'}</button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 앱 실행
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // 초기 아이콘 생성
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>
